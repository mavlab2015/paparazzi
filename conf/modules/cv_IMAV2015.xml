<!DOCTYPE module SYSTEM "module.dtd">

<module name="cv_IMAV2015" dir="computer_vision">
  <doc>
    <description>
        Hovers the drone above the detected image object.

        Computes Pitch- and roll attide from downward looking camera looking at a textured floor.
        - Sonar is required.
        - Controller can hold position
    </description>

    <!-- Satbilization parameters and gains -->
    <section name="VISION" prefix="VISION_">
      <define name="PHI_PGAIN" value="300" description="Vision hover proportional gain on the roll velocity error"/>
      <define name="PHI_IGAIN" value="0" description="Vision hover integrated gain on the summed roll velocity error"/>
      <define name="PHI_DGAIN" value="0" description="Vision hover differential gain on the roll velocity error"/>
      <define name="THETA_PGAIN" value="300" description="Vision hover proportional gain on the pitch velocity error"/>
      <define name="THETA_IGAIN" value="0" description="Vision hover integrated gain on the summed pitch velocity error"/>
      <define name="THETA_DGAIN" value="0" description="Vision hover differential gain on the pitch velocity error"/>
      
      <define name="M" value="8" description="The distance between the pixel of interest and farthest neighbor pixel [pixel]"/>
      <define name="m" value="3" description="The safety margin around the pixel of interest [pixel]"/>
      <define name="t" value="5" description="Threshold for intensity difference"/>
      <define name="IN" value="3" description="The number of minimum inliers required"/>
    </section>

    <!-- Vision Hover calculation parameters -->
    <section name="VISIONHOVER" prefix="VISIONHOVER_">
      <define name="AGL_ID" value="ABI_SENDER_ID" description="ABI sender id for AGL message (sonar measurement) (default: ABI_BROADCAST)"/>

      <!-- Video device parameters -->
      <define name="DEVICE" value="/dev/video2" description="The V4L2 camera device that is used for the calculations"/>
      <define name="DEVICE_SIZE" value="320,240" description="The V4L2 camera device width and height"/>
      <define name="DEVICE_BUFFERS" value="15" description="Amount of V4L2 video buffers"/>
      <define name="SUBDEV" description="The V4L2 subdevice to initialize before the main device"/>

      <!-- Camera parameters -->
      <define name="FOV_W" value="0.89360857702" description="The field of view width of the bottom camera (Defaults are from an ARDrone 2)"/>
      <define name="FOV_H" value="0.67020643276" description="The field of view height of the bottom camera (Defaults are from an ARDrone 2)"/>
      <define name="FX" value="343.1211" description="Field in the x direction of the camera [px/rad] (Defaults are from an ARDrone 2)"/>
      <define name="FY" value="348.5053" description="Field in the y direction of the camera [px/rad] (Defaults are from an ARDrone 2)"/>

    
    </section>
  </doc>

  <settings>
	  <dl_settings NAME="Vision stabilization">
      <!-- Satabilization loop parameters and gains -->
	      <dl_settings name="vision_stab">
			<dl_setting var="visionhover_stab.phi_pgain" module="computer_vision/IMAV2015_visionhover_module" min="0" step="1" max="10000" shortname="kp_v_phi" param="VISION_PHI_PGAIN"/>
			<dl_setting var="visionhover_stab.phi_igain" module="computer_vision/IMAV2015_visionhover_module" min="0" step="1" max="1000" shortname="ki_v_phi" param="VISION_PHI_IGAIN"/>
			<dl_setting var="visionhover_stab.phi_dgain" module="computer_vision/IMAV2015_visionhover_module" min="0" step="1" max="1000" shortname="kd_v_phi" param="VISION_PHI_DGAIN"/>
			<dl_setting var="visionhover_stab.theta_pgain" module="computer_vision/IMAV2015_visionhover_module" min="0" step="1" max="10000" shortname="kp_v_theta" param="VISION_THETA_PGAIN"/>
			<dl_setting var="visionhover_stab.theta_igain" module="computer_vision/IMAV2015_visionhover_module" min="0" step="1" max="1000" shortname="ki_v_theta" param="VISION_THETA_IGAIN"/>
			<dl_setting var="visionhover_stab.theta_dgain" module="computer_vision/IMAV2015_visionhover_module" min="0" step="1" max="1000" shortname="kd_v_theta" param="VISION_THETA_DGAIN"/>
			
			<dl_setting var="visionhover_param.M" module="computer_vision/IMAV2015_visionhover_module" min="0" step="1" max="100" shortname="M" param="VISION_M"/>
			<dl_setting var="visionhover_param.m" module="computer_vision/IMAV2015_visionhover_module" min="0" step="1" max="10" shortname="m" param="VISION_m"/>
			<dl_setting var="visionhover_param.t" module="computer_vision/IMAV2015_visionhover_module" min="0" step="1" max="50" shortname="t" param="VISION_t"/>
			<dl_setting var="visionhover_param.IN" module="computer_vision/IMAV2015_visionhover_module" min="0" step="1" max="10" shortname="IN" param="VISION_IN"/>
			</dl_settings>
          </dl_settings>
  </settings>
 
 
  <header>
    <file name="IMAV2015_visionhover_module.h"/>
  </header>

  <init fun="visionhover_module_init()"/>
  <periodic fun="visionhover_module_run()" start="visionhover_module_start()" stop="visionhover_module_stop()" autorun="TRUE"/>

  <makefile target="ap">
    <!-- Include the needed Computer Vision files -->
    <define name="modules/computer_vision" type="include"/>
    <file name="image.c" dir="modules/computer_vision/lib/vision"/>
    <file name="jpeg.c" dir="modules/computer_vision/lib/encoding"/>
    <file name="rtp.c" dir="modules/computer_vision/lib/encoding"/>
    <file name="v4l2.c" dir="modules/computer_vision/lib/v4l"/>

    <!-- The optical flow module (calculator+stabilization) -->
    <file name="IMAV2015_visionhover_module.c"/>
    <file name="IMAV2015_vision.c" dir="modules/computer_vision/visionhover"/>
    <file name="IMAV2015_stabilization.c" dir="modules/computer_vision/visionhover"/>


    <raw>
      VIEWVIDEO_HOST        ?= $(MODEM_HOST)
      VIEWVIDEO_PORT_OUT    ?= 5000
      VIEWVIDEO_BROADCAST   ?= $(MODEM_BROADCAST)

      VIEWVID_CFLAGS  = -DVIEWVIDEO_HOST=$(VIEWVIDEO_HOST) -DVIEWVIDEO_PORT_OUT=$(VIEWVIDEO_PORT_OUT)
      ifeq ($(VIEWVIDEO_USE_NC),)
        ap.CFLAGS += $(VIEWVID_CFLAGS) -DVIEWVIDEO_BROADCAST=$(VIEWVIDEO_BROADCAST)
      else
        ap.CFLAGS += $(VIEWVID_CFLAGS) -DVIEWVIDEO_USE_NC
      endif

      ap.CFLAGS += -DGUIDANCE_V_MODE_MODULE_SETTING=GUIDANCE_V_MODE_HOVER
      ap.CFLAGS += -DGUIDANCE_H_MODE_MODULE_SETTING=GUIDANCE_H_MODE_MODULE
    </raw>
  </makefile>

  <makefile target="nps">
    <file name="viewvideo_nps.c"/>
  </makefile>

</module>

